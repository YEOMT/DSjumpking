<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ëŒ€ì†¡ ì í”„í‚¹ - ìºë¦­í„° ì„ íƒ</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Noto+Sans+KR:wght@400;700&display=swap');

        body {
            margin: 0; padding: 0;
            background-color: #1a1a2e; color: white;
            font-family: 'Noto Sans KR', sans-serif;
            overflow: hidden; touch-action: none;
            display: flex; justify-content: center; align-items: center;
            height: 100vh; height: 100dvh; 
            padding-bottom: env(safe-area-inset-bottom);
            box-sizing: border-box;
        }

        #game-container {
            position: relative; width: 100%; max-width: 600px; height: 100%;
            background: linear-gradient(180deg, #16213e 0%, #0f3460 100%);
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            overflow: hidden;
        }

        canvas { display: block; width: 100%; height: 100%; }

        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between;
            padding: 20px; box-sizing: border-box; z-index: 10;
        }

        .score-board {
            font-family: 'Black Han Sans', sans-serif;
            font-size: 24px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
        }

        #top-controls {
            display: flex; justify-content: space-between; align-items: flex-start;
            pointer-events: auto;
        }
        
        .top-right-group {
            display: flex; gap: 10px;
        }

        .save-btn {
            background: #e94560; color: white; border: none;
            padding: 8px 16px; border-radius: 20px; font-weight: bold;
            cursor: pointer; font-family: 'Noto Sans KR', sans-serif;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3); font-size: 14px;
        }
        .save-btn:active { transform: scale(0.95); }
        
        .icon-btn {
            background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);
            width: 36px; height: 36px; border-radius: 50%; 
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; font-size: 18px;
        }
        .icon-btn:active { transform: scale(0.95); }

        /* ê³µí†µ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal-box {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            text-align: center; background: rgba(0, 0, 0, 0.95);
            padding: 25px; border-radius: 15px; border: 3px solid #e94560;
            pointer-events: auto; display: flex; flex-direction: column;
            gap: 15px; z-index: 20; width: 85%; max-width: 340px;
        }

        h1 { margin: 0; color: #e94560; font-family: 'Black Han Sans', sans-serif; font-size: 32px; letter-spacing: -1px; }
        
        input[type="text"] {
            padding: 10px; border-radius: 5px; border: none;
            font-size: 16px; text-align: center; font-family: 'Noto Sans KR', sans-serif;
            width: 100%; box-sizing: border-box;
        }

        .primary-btn {
            background: #e94560; color: white; border: none;
            padding: 12px 24px; font-size: 18px; border-radius: 8px;
            cursor: pointer; font-weight: bold; transition: transform 0.1s;
        }
        .primary-btn:active { transform: scale(0.95); }

        .secondary-btn {
            background: transparent; color: #4cc9f0; border: 2px solid #4cc9f0;
            padding: 8px 16px; font-size: 14px; border-radius: 8px;
            cursor: pointer; font-weight: bold;
        }
        
        .cancel-btn {
            background: #555; color: white; border: none;
            padding: 8px 16px; font-size: 14px; border-radius: 8px;
            cursor: pointer; font-weight: bold;
        }

        /* ìºë¦­í„° ì„ íƒ ìŠ¤íƒ€ì¼ */
        .char-select-container {
            display: flex; justify-content: center; gap: 10px; margin: 10px 0;
        }
        .char-btn {
            background: #222; border: 2px solid #555; border-radius: 10px;
            padding: 10px; cursor: pointer; width: 80px; transition: all 0.2s;
            display: flex; flex-direction: column; align-items: center; gap: 5px;
        }
        .char-btn.selected {
            border-color: #ffd700; background: #333; transform: scale(1.05);
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }
        .char-icon { font-size: 30px; }
        .char-name { font-size: 12px; font-weight: bold; color: #ccc; }
        .char-desc { font-size: 10px; color: #888; }

        /* Leaderboard Modal */
        #leaderboard-modal {
            display: none; position: absolute;
            top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 85%; height: 70%;
            background: rgba(26, 26, 46, 0.95);
            border: 2px solid #ffd700; border-radius: 10px;
            z-index: 30; flex-direction: column;
            padding: 20px; box-sizing: border-box; color: white;
        }
        
        #leaderboard-list {
            flex: 1; overflow-y: auto; margin: 10px 0;
            border-top: 1px solid #444; border-bottom: 1px solid #444;
        }

        .rank-item {
            display: flex; justify-content: space-between;
            padding: 10px; border-bottom: 1px solid #333;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .rank-item:nth-child(1) { color: #ffd700; font-weight: bold; font-size: 1.1em; }
        .rank-item:nth-child(2) { color: #c0c0c0; font-weight: bold; }
        .rank-item:nth-child(3) { color: #cd7f32; font-weight: bold; }

        .close-btn {
            align-self: flex-end; background: #555; color: white;
            border: none; padding: 5px 15px; border-radius: 5px; cursor: pointer;
        }

        .touch-guide {
            text-align: center; font-size: 12px; opacity: 0.5; margin-bottom: 20px;
        }
        
        #status-indicator {
            position: absolute; top: 10px; right: 10px;
            font-size: 10px; color: #aaa; z-index: 100;
        }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>
    <div id="status-indicator">ì—°ê²° ì¤‘...</div>

    <div id="ui-layer">
        <div id="top-controls">
            <div>
                <div class="score-board">í˜„ì¬: <span id="current-height">0</span>m</div>
                <div class="score-board" style="font-size: 18px; color: #ffd700;">ìµœê³ : <span id="max-height">0</span>m</div>
            </div>
            <div class="top-right-group">
                <button class="icon-btn" id="music-btn">ğŸµ</button>
                <button class="save-btn" id="save-score-btn" style="display:none;">ğŸ ë“±ë°˜ ì¢…ë£Œ ë° ì €ì¥</button>
            </div>
        </div>
        <div class="touch-guide">PC: ë°©í–¥í‚¤ / ìŠ¤í˜ì´ìŠ¤ë°”(ì í”„) + ë°©í–¥í‚¤</div>
    </div>

    <!-- ì‹œì‘ í™”ë©´ & ìºë¦­í„° ì„ íƒ -->
    <div id="message-box" class="modal-box">
        <h1>ëŒ€ì†¡ ì í”„í‚¹</h1>
        <p style="font-size:14px; color:#ccc; margin-bottom:5px;">ìºë¦­í„°ë¥¼ ì„ íƒí•˜ì„¸ìš”</p>
        
        <div class="char-select-container">
            <div class="char-btn selected" onclick="selectChar('king')">
                <div class="char-icon">ğŸ‘‘</div>
                <div class="char-name">ì™•</div>
                <div class="char-desc">ë°¸ëŸ°ìŠ¤í˜•<br>ë¸Œë ˆì´í¬O</div>
            </div>
            <div class="char-btn" onclick="selectChar('frog')">
                <div class="char-icon">ğŸ¸</div>
                <div class="char-name">ê°œêµ¬ë¦¬</div>
                <div class="char-desc">ì í”„ë ¥â†‘<br>ë§¤ìš° ë¯¸ë„ëŸ¬ì›€</div>
            </div>
            <div class="char-btn" onclick="selectChar('ninja')">
                <div class="char-icon">ğŸ¥·</div>
                <div class="char-name">ë‹Œì</div>
                <div class="char-desc">ì´ë™ì†ë„â†‘<br>ë²½ì í”„ ê°€ëŠ¥</div>
            </div>
        </div>

        <button class="primary-btn" id="start-btn">ë“±ë°˜ ì‹œì‘</button>
        <button class="secondary-btn" id="show-rank-btn" style="margin-top:5px;">ğŸ† ì‹¤ì‹œê°„ ë­í‚¹</button>
    </div>

    <!-- ì¢…ë£Œ ì‹œ ì´ë¦„ ì…ë ¥ ëª¨ë‹¬ -->
    <div id="name-input-modal" class="modal-box" style="display:none;">
        <h2 style="margin:0; color:#ffd700;">ê¸°ë¡ ì €ì¥</h2>
        <p>ëª…ì˜ˆì˜ ì „ë‹¹ì— ë‚¨ê¸¸<br>ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
        <input type="text" id="end-player-name" placeholder="ì´ë¦„ (8ì ì´ë‚´)" maxlength="8">
        <div style="display:flex; gap:10px; justify-content: center;">
            <button class="cancel-btn" id="cancel-save-btn">ì·¨ì†Œ</button>
            <button class="primary-btn" id="confirm-save-btn">ì €ì¥í•˜ê¸°</button>
        </div>
    </div>

    <!-- ë­í‚¹ ëª¨ë‹¬ -->
    <div id="leaderboard-modal">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 style="margin:0; color:#ffd700;">TOP 10 ëª…ì˜ˆì˜ ì „ë‹¹</h2>
            <button class="close-btn" id="close-rank-btn">ë‹«ê¸°</button>
        </div>
        <div style="display:flex; justify-content:space-between; padding: 5px; font-size: 12px; color: #aaa;">
            <span>ìˆœìœ„ / ì´ë¦„</span>
            <span>ë†’ì´</span>
        </div>
        <div id="leaderboard-list">
            <div style="text-align:center; padding:20px;">ë¡œë”© ì¤‘...</div>
        </div>
    </div>
</div>

<script type="module">
    // =========================================================
    // Firebase Configuration
    // =========================================================
    const firebaseConfig = {
        apiKey: "AIzaSyBtK7NAfw4wDsS4LRacWF78PHT3zls50IQ",
        authDomain: "dsgames-fecef.firebaseapp.com",
        projectId: "dsgames-fecef",
        storageBucket: "dsgames-fecef.firebasestorage.app",
        messagingSenderId: "723943517090",
        appId: "1:723943517090:web:3e8596971cedf46cc460fb",
        measurementId: "G-GNVR6N4LKQ"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, doc, setDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    let app, auth, db;
    let isOnline = false;
    let currentUser = null;
    let playerName = "";
    let rankUnsubscribe = null;

    // --- BGM ì„¤ì • ---
    // dropbox link with dl=1 for direct streaming
    const bgmUrl = "https://www.dropbox.com/scl/fi/b64dt3f0lzxyuyhiwj3s6/JumpKingPeace.mp3?rlkey=gv0yeqhb1nzhj9ctucdb9clh5&st=kc3xjgz3&dl=1";
    const bgMusic = new Audio(bgmUrl);
    bgMusic.loop = true;
    bgMusic.volume = 0.4; // ì ì ˆí•œ ë³¼ë¥¨

    // ì´ˆê¸°í™” ë¡œì§
    if (firebaseConfig.apiKey) {
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            isOnline = true;
            document.getElementById('status-indicator').innerText = "ì˜¨ë¼ì¸ (ë­í‚¹ ê°€ëŠ¥)";
            
            signInAnonymously(auth).catch(e => console.error(e));
            onAuthStateChanged(auth, (user) => {
                if(user) {
                    currentUser = user;
                    console.log("Logged in:", user.uid);
                }
            });

        } catch (e) {
            console.error("Firebase Init Failed:", e);
            document.getElementById('status-indicator').innerText = "ì˜¤ë¥˜: ì„¤ì • í™•ì¸ í•„ìš”";
        }
    } else {
        document.getElementById('status-indicator').innerText = "ì˜¤í”„ë¼ì¸ ëª¨ë“œ";
    }

    // --------------------------------------------------------
    // ê²Œì„ ë° UI ë¡œì§
    // --------------------------------------------------------
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    // UI ìš”ì†Œ
    const messageBox = document.getElementById('message-box');
    const nameInputModal = document.getElementById('name-input-modal');
    const endNameInput = document.getElementById('end-player-name');
    
    const startBtn = document.getElementById('start-btn');
    const showRankBtn = document.getElementById('show-rank-btn');
    const leaderboardModal = document.getElementById('leaderboard-modal');
    const closeRankBtn = document.getElementById('close-rank-btn');
    const saveScoreBtn = document.getElementById('save-score-btn');
    const leaderboardList = document.getElementById('leaderboard-list');
    
    const confirmSaveBtn = document.getElementById('confirm-save-btn');
    const cancelSaveBtn = document.getElementById('cancel-save-btn');
    const musicBtn = document.getElementById('music-btn');

    // ê²Œì„ ë³€ìˆ˜
    let gameState = 'START';
    let width, height;
    let cameraY = 0;
    let score = 0;
    let highScore = 0;
    
    // ìºë¦­í„° ì„¤ì • (ë°¸ëŸ°ìŠ¤ ì¡°ì •)
    const CHARACTERS = {
        king: { 
            emoji: 'ğŸ‘‘', name: "ì™•",
            jumpMult: 0.22, 
            walkSpeed: 4, 
            friction: 0.2, 
            wallSlide: false
        },
        frog: { 
            emoji: 'ğŸ¸', name: "ê°œêµ¬ë¦¬",
            jumpMult: 0.28, 
            walkSpeed: 2.5, 
            friction: 0.92, 
            wallSlide: false
        },
        ninja: { 
            emoji: 'ğŸ¥·', name: "ë‹Œì",
            jumpMult: 0.155, 
            walkSpeed: 6, 
            friction: 0.2, 
            wallSlide: true 
        }
    };
    let selectedCharKey = 'king';

    // í”Œë ˆì´ì–´ ê°ì²´
    const player = {
        x: 0, y: 0, vx: 0, vy: 0, width: 30, height: 30,
        emoji: 'ğŸ‘‘', isGrounded: false, isCharging: false, isWallSliding: false,
        charge: 0, facing: 1,
        // ë™ì  ìŠ¤íƒ¯
        jumpMult: 0.22,
        walkSpeed: 4,
        friction: 0.2,
        wallSlide: false,
        touchingWall: 0 // -1: Left, 1: Right, 0: None
    };
    
    let platforms = [];
    const keys = { ArrowLeft: false, ArrowRight: false, Space: false };
    
    // ë¬¼ë¦¬ ìƒìˆ˜
    const GRAVITY = 0.5;
    const AIR_RESISTANCE = 0.99;
    const BOUNCE = -0.5;
    const MAX_CHARGE = 100;
    const WALK_ACCEL = 0.8;

    window.selectChar = function(key) {
        selectedCharKey = key;
        document.querySelectorAll('.char-btn').forEach(btn => btn.classList.remove('selected'));
        const buttons = document.querySelectorAll('.char-btn');
        if(key === 'king') buttons[0].classList.add('selected');
        if(key === 'frog') buttons[1].classList.add('selected');
        if(key === 'ninja') buttons[2].classList.add('selected');
    };

    function resize() {
        const container = document.getElementById('game-container');
        if(!container) return;
        width = canvas.width = container.offsetWidth;
        height = canvas.height = container.offsetHeight;
        if(gameState === 'START' && width > 0) initGame();
    }
    window.addEventListener('resize', resize);
    
    window.addEventListener('keydown', (e) => {
        if (nameInputModal.style.display === 'flex') return;

        if (e.code === 'Space') {
            if (gameState !== 'PLAYING') return;
            keys.Space = true;
            if ((player.isGrounded || player.touchingWall !== 0) && !player.isCharging) {
                if (player.isGrounded || (player.wallSlide && player.touchingWall !== 0)) {
                    player.isCharging = true;
                    player.charge = 0;
                    playSound('charge');
                }
            }
        }
        if (e.code === 'ArrowLeft') { keys.ArrowLeft = true; player.facing = -1; }
        if (e.code === 'ArrowRight') { keys.ArrowRight = true; player.facing = 1; }
    });
    window.addEventListener('keyup', (e) => {
        if (e.code === 'Space') {
            keys.Space = false;
            if (gameState === 'PLAYING' && player.isCharging) jump();
        }
        if (e.code === 'ArrowLeft') keys.ArrowLeft = false;
        if (e.code === 'ArrowRight') keys.ArrowRight = false;
    });
    canvas.addEventListener('touchstart', (e) => {
        e.preventDefault(); 
        if(gameState !== 'PLAYING' || nameInputModal.style.display === 'flex') return;
        
        const t = e.touches[0];
        const tx = t.clientX - canvas.getBoundingClientRect().left;
        if(tx < width/2) { keys.ArrowLeft = true; keys.ArrowRight = false; player.facing = -1; }
        else { keys.ArrowRight = true; keys.ArrowLeft = false; player.facing = 1; }
        
        if((player.isGrounded || (player.wallSlide && player.touchingWall !== 0)) && !player.isCharging) {
            player.isCharging = true; player.charge = 0; keys.Space = true; playSound('charge');
        }
    }, {passive:false});
    canvas.addEventListener('touchend', (e) => {
        e.preventDefault(); 
        if(gameState === 'PLAYING' && player.isCharging) jump();
        keys.ArrowLeft = false; keys.ArrowRight = false; keys.Space = false;
    });

    // ì‹œì‘ ë²„íŠ¼ (BGM ì¬ìƒ)
    startBtn.addEventListener('click', () => {
        messageBox.style.display = 'none';
        saveScoreBtn.style.display = 'block';
        
        // BGM ì¬ìƒ ì‹œë„
        bgMusic.play().catch(e => console.log("Audio play failed:", e));
        
        startGame();
    });

    // ìŒì•… ë²„íŠ¼ í† ê¸€
    musicBtn.addEventListener('click', () => {
        if (bgMusic.paused) {
            bgMusic.play();
            musicBtn.innerText = "ğŸµ";
            musicBtn.style.opacity = "1";
        } else {
            bgMusic.pause();
            musicBtn.innerText = "ğŸ”‡";
            musicBtn.style.opacity = "0.5";
        }
        // í¬ì»¤ìŠ¤ í•´ì œ (ìŠ¤í˜ì´ìŠ¤ë°” ëˆ„ë¥¼ ë•Œ ë²„íŠ¼ ëˆŒë¦¼ ë°©ì§€)
        musicBtn.blur();
    });

    saveScoreBtn.addEventListener('click', () => {
        nameInputModal.style.display = 'flex';
        endNameInput.value = ''; 
        endNameInput.focus();
    });

    confirmSaveBtn.addEventListener('click', () => {
        const name = endNameInput.value.trim();
        if(!name) { alert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!"); return; }
        playerName = name;
        nameInputModal.style.display = 'none';
        saveAndEndGame();
    });

    cancelSaveBtn.addEventListener('click', () => {
        nameInputModal.style.display = 'none';
    });
    
    showRankBtn.addEventListener('click', () => {
        leaderboardModal.style.display = 'flex';
        startRankListener(); 
    });
    
    closeRankBtn.addEventListener('click', () => {
        leaderboardModal.style.display = 'none';
        if(rankUnsubscribe) { rankUnsubscribe(); rankUnsubscribe = null; }
    });

    async function saveAndEndGame() {
        try {
            const record = {
                name: playerName,
                score: highScore,
                character: CHARACTERS[selectedCharKey].emoji, 
                updatedAt: isOnline ? serverTimestamp() : Date.now()
            };

            if(isOnline && currentUser) {
                const userDoc = doc(db, 'jump_king_ranking', currentUser.uid);
                await setDoc(userDoc, record);
            } else {
                const localData = JSON.parse(localStorage.getItem('jumpking_rank') || '[]');
                const idx = localData.findIndex(i => i.name === playerName);
                if(idx >= 0) {
                    if(highScore > localData[idx].score) {
                        localData[idx].score = highScore;
                        localData[idx].character = record.character;
                    }
                } else {
                    localData.push(record);
                }
                localStorage.setItem('jumpking_rank', JSON.stringify(localData));
            }
            
            gameState = 'GAMEOVER';
            showGameOverUI();
        } catch(e) {
            console.error(e);
            alert("ì €ì¥ ì‹¤íŒ¨: Firestore ê·œì¹™ í™•ì¸ í•„ìš”");
        }
    }

    function startRankListener() {
        leaderboardList.innerHTML = '<div style="text-align:center; padding:20px;">ë¡œë”© ì¤‘...</div>';
        
        if(isOnline) {
            const colRef = collection(db, 'jump_king_ranking');
            rankUnsubscribe = onSnapshot(colRef, (snapshot) => {
                const data = [];
                snapshot.forEach(d => data.push(d.data()));
                data.sort((a,b) => b.score - a.score);
                renderLeaderboard(data.slice(0, 10));
            }, (error) => {
                console.error("Rank Error:", error);
                leaderboardList.innerHTML = '<div style="text-align:center; color:red;">ë­í‚¹ ë¡œë“œ ì‹¤íŒ¨</div>';
            });
        } else {
            const data = JSON.parse(localStorage.getItem('jumpking_rank') || '[]');
            data.sort((a,b) => b.score - a.score);
            renderLeaderboard(data.slice(0, 10), true);
        }
    }

    function renderLeaderboard(data, isOffline = false) {
        let html = '';
        if(data.length === 0) {
            html = '<div style="text-align:center; padding:20px;">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. 1ë“±ì´ ë˜ì–´ë³´ì„¸ìš”!</div>';
        } else {
            data.forEach((item, index) => {
                const charEmoji = item.character || 'ğŸ‘‘';
                html += `
                    <div class="rank-item">
                        <span>${index+1}. ${charEmoji} ${escapeHtml(item.name)}</span>
                        <span>${item.score}m</span>
                    </div>
                `;
            });
        }
        if(isOffline) html += '<div style="text-align:center; font-size:10px; color:#666; padding:10px;">* ì˜¤í”„ë¼ì¸ ëª¨ë“œ (ë¡œì»¬ ê¸°ë¡)</div>';
        leaderboardList.innerHTML = html;
    }

    function showGameOverUI() {
        saveScoreBtn.style.display = 'none';
        messageBox.style.display = 'flex';
        document.querySelector('.char-select-container').style.display = 'none';
        document.querySelector('#message-box p').innerText = "ê¸°ë¡ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.";
        
        messageBox.innerHTML = `
            <h1>ğŸ ë“±ë°˜ ì¢…ë£Œ</h1>
            <p style="font-size:20px;">${escapeHtml(playerName)}ë‹˜<br>
            <strong style="font-size:32px; color:#ffd700;">${highScore}m</strong></p>
            <p style="color:#aaa; font-size:14px;">ìºë¦­í„°: ${CHARACTERS[selectedCharKey].emoji} ${CHARACTERS[selectedCharKey].name}</p>
            <button class="primary-btn" id="restart-btn">ë‹¤ì‹œ ë„ì „</button>
            <button class="secondary-btn" id="show-rank-btn-end">ğŸ† ë­í‚¹ ë³´ê¸°</button>
        `;
        document.getElementById('restart-btn').addEventListener('click', () => location.reload());
        document.getElementById('show-rank-btn-end').addEventListener('click', () => {
            leaderboardModal.style.display = 'flex';
            startRankListener();
        });
    }

    function escapeHtml(text) {
        if(!text) return "";
        return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
    }

    // ì˜¤ë””ì˜¤ ë° ê²Œì„ ë¡œì§
    let audioCtx;
    function playSound(t) {
        if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
        if(audioCtx.state === 'suspended') audioCtx.resume();
        const o=audioCtx.createOscillator(), g=audioCtx.createGain();
        o.connect(g); g.connect(audioCtx.destination);
        const now=audioCtx.currentTime;
        
        // ì í”„ ì†Œë¦¬ë§Œ ë‚¨ê¹€ (ë‚˜ë¨¸ì§€ ì œê±°)
        if(t==='jump'){
            o.frequency.setValueAtTime(200,now);
            o.frequency.exponentialRampToValueAtTime(600,now+0.2);
            g.gain.setValueAtTime(0.1, now); 
            g.gain.exponentialRampToValueAtTime(0.01,now+0.2);
            o.start(now);o.stop(now+0.2);
        }
    }

    function initGame() {
        if(!width) return;
        
        const charData = CHARACTERS[selectedCharKey];
        player.emoji = charData.emoji;
        player.jumpMult = charData.jumpMult;
        player.walkSpeed = charData.walkSpeed;
        player.friction = charData.friction;
        player.wallSlide = charData.wallSlide;
        player.isWallSliding = false;
        player.touchingWall = 0;

        player.x = width/2 - 15; 
        player.y = height-150; 
        player.vx=0; player.vy=0;
        cameraY=0; score=0; highScore=0;
        generatePlatforms();
    }
    function startGame() { initGame(); gameState='PLAYING'; update(); }
    
    function generatePlatforms() {
        platforms = [{x:0, y:height-80, w:width, h:80, type:'ground'}]; 
        let cY = height-200; 
        // 1300ê°œë¡œ ëŠ˜ë ¤ì„œ 10000mê¹Œì§€ ì»¤ë²„
        for(let i=0; i<1300; i++) {
            // ë‚œì´ë„ ê³¡ì„  ì¡°ì • (1000ë²ˆì§¸ê¹Œì§€ ì„œì„œíˆ ì–´ë ¤ì›Œì§)
            const diff = Math.min(1, i/1000);
            let pW, pH;
            if(Math.random()<0.2) { pW=40+Math.random()*30; pH=15+Math.random()*10; }
            else if(Math.random()<0.3) { pW=60+Math.random()*60; pH=30+Math.random()*40; }
            else { pW=70+Math.random()*120*(1-diff*0.5); pH=15+Math.random()*15; }
            
            pW = Math.max(40, pW);
            let pX = Math.random()*(width-pW);
            
            platforms.push({x:pX, y:cY, w:pW, h:pH, color:`hsl(${Math.random()*360},60%,60%)`});
            cY -= (Math.random()*90 + 60);
        }
    }
    
    function jump() {
        player.isCharging=false; 
        
        let dx=0; if(keys.ArrowLeft) dx=-1; if(keys.ArrowRight) dx=1;
        const p = player.charge * player.jumpMult; 
        
        // ë‹Œì ë²½ ì í”„: ë²½ì— ë‹¿ì•„ìˆê³ (touchingWall != 0), ë‹Œì íŠ¹ì„±(wallSlide)ì¼ ë•Œ
        if (player.wallSlide && player.touchingWall !== 0) {
             if(dx !== 0) {
                 player.vx = dx * p * 0.7; 
                 player.vy = -p * 0.9;
             } else {
                 player.vx = 0;
                 player.vy = -p;
             }
        } else if (player.isGrounded) {
            if(dx!==0) { player.vx=dx*p*0.6; player.vy=-p*0.9; } else { player.vx=0; player.vy=-p; }
        } else {
             if(dx!==0) { player.vx=dx*p*0.6; player.vy=-p*0.9; } else { player.vx=0; player.vy=-p; }
        }

        player.isGrounded=false;
        playSound('jump');
    }

    function update() {
        if(gameState!=='PLAYING') return;
        
        // 1. ì¶©ì „ ë¡œì§
        if(player.isCharging) {
            player.vx *= player.friction; 
            if(player.charge < MAX_CHARGE) player.charge+=2;
        } else player.charge=0;

        // 2. ë¬¼ë¦¬ ë° ì´ë™ ë¡œì§
        if(player.isGrounded) {
            if(!player.isCharging) {
                let moving = false;
                if(keys.ArrowLeft) { 
                    player.vx -= WALK_ACCEL; 
                    player.facing=-1; 
                    moving=true; 
                }
                if(keys.ArrowRight) { 
                    player.vx += WALK_ACCEL; 
                    player.facing=1; 
                    moving=true; 
                }
                
                if(Math.abs(player.vx) > player.walkSpeed) {
                    player.vx = Math.sign(player.vx) * player.walkSpeed;
                }

                if(!moving) {
                    player.vx *= player.friction; 
                    if(Math.abs(player.vx) < 0.1) player.vx = 0;
                } else {
                    player.vx *= 0.85; 
                }
            } else {
                player.vx *= player.friction;
            }
        } else {
            player.vx *= AIR_RESISTANCE;
        }

        player.vy += GRAVITY; 
        
        // --- ë‹Œì ë²½íƒ€ê¸° ë¡œì§ ---
        if(player.wallSlide && player.touchingWall !== 0 && player.vy > 0) {
            // [NERF] ë¯¸ë„ëŸ¬ì§€ëŠ” ì†ë„ ëŒ€í­ ì¦ê°€ (1.5 -> 3.5)
            // ì¶©ì „ ì¤‘ì´ê±°ë‚˜ í‚¤ë¥¼ ëˆ„ë¥´ê³  ìˆì–´ë„ ë¹ ë¥´ê²Œ ë¯¸ë„ëŸ¬ì§
            player.vy = Math.min(player.vy, 3.5); 
        }

        player.x += player.vx; 
        player.y += player.vy;

        // ë²½ ì¶©ëŒ ë° ì ‘ì´‰ ê°ì§€
        player.touchingWall = 0; // ì´ˆê¸°í™”

        if(player.x <= 0){ 
            player.x = 0;
            player.touchingWall = -1;
            
            if(player.wallSlide && !player.isGrounded) {
                // í•­ìƒ 0ìœ¼ë¡œ ìˆ˜ë ´ (ë²½ì— ë¶™ìŒ)
                player.vx = 0; 
            } else {
                player.vx *= BOUNCE;
            }
        }
        else if(player.x + player.width >= width){ 
            player.x = width - player.width;
            player.touchingWall = 1;

            if(player.wallSlide && !player.isGrounded) {
                player.vx = 0;
            } else {
                player.vx *= BOUNCE;
            }
        }

        // í”Œë«í¼ ì¶©ëŒ
        player.isGrounded=false;
        for(let p of platforms) {
            if(player.x < p.x+p.w && player.x+player.width > p.x && player.y < p.y+p.h && player.y+player.height > p.y) {
                const py = player.y-player.vy;
                if(py+player.height <= p.y+10 && player.vy>=0) {
                    player.y = p.y-player.height; player.vy=0; player.isGrounded=true;
                    if(Math.abs(player.vx)<0.1 && !keys.ArrowLeft && !keys.ArrowRight) player.vx=0;
                    playSound('land');
                } else {
                    if(py >= p.y+p.h) { player.y=p.y+p.h; player.vy *= -0.5; playSound('bump'); }
                    else player.vx *= -1;
                }
            }
        }
        if(player.y > height+500) { player.y=height-150; player.vy=0; cameraY=0; }
        
        const tY = -player.y + height*0.7;
        cameraY += (tY-cameraY)*0.1; if(cameraY<0) cameraY=0;
        
        score = Math.floor(Math.max(0, height-20-player.y)/10);
        if(score>highScore) highScore=score;
        
        document.getElementById('current-height').innerText=score;
        document.getElementById('max-height').innerText=highScore;
        
        draw();
        requestAnimationFrame(update);
    }

    function draw() {
        ctx.fillStyle='#1a1a2e'; ctx.fillRect(0,0,width,height);
        ctx.save(); ctx.translate(0, cameraY);
        platforms.forEach(p => {
            if(p.y+cameraY > -100 && p.y+cameraY < height+100) {
                ctx.fillStyle=p.type==='ground'?'#555':p.color; ctx.fillRect(p.x,p.y,p.w,p.h);
                ctx.strokeStyle='white'; ctx.strokeRect(p.x,p.y,p.w,p.h);
            }
        });
        ctx.font=`${player.width}px Arial`; ctx.textAlign='center'; ctx.textBaseline='middle';
        ctx.save(); ctx.translate(player.x+player.width/2, player.y+player.height/2);
        ctx.scale(player.facing,1); ctx.fillText(player.emoji,0,2); ctx.restore();
        
        if(player.isCharging) {
            const bw=40, bh=6, bx=player.x+player.width/2-bw/2, by=player.y-15;
            ctx.fillStyle='#333'; ctx.fillRect(bx,by,bw,bh);
            ctx.fillStyle = (player.charge/MAX_CHARGE)*bw > bw*0.8 ? '#ff3333':'#ffcc00';
            ctx.fillRect(bx,by,(player.charge/MAX_CHARGE)*bw,bh);
            ctx.strokeStyle='white'; ctx.strokeRect(bx,by,bw,bh);
        }
        ctx.restore();
    }
    resize();
</script>
</body>
</html>
